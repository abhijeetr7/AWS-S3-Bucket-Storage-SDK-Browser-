<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS S3 Browser SDK</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to start to prevent content from being too high */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        input[type="text"], input[type="file"] {
            border: 1px solid #d1d5db;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #4338ca; /* Darker indigo */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .warning {
            background-color: #fef2f2; /* Red-100 */
            color: #ef4444; /* Red-500 */
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #fca5a5; /* Red-300 */
            font-weight: 500;
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 500;
        }
        .message-box.success {
            background-color: #ecfdf5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #a7f3d0; /* Green-300 */
        }
        .message-box.error {
            background-color: #fef2f2; /* Red-100 */
            color: #dc2626; /* Red-600 */
            border: 1px solid #fca5a5; /* Red-300 */
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-actions button {
            margin-left: 8px;
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        /* Specific colors for action buttons */
        .file-actions .preview-btn {
            background-color: #f59e0b; /* Amber */
        }
        .file-actions .preview-btn:hover {
            background-color: #d97706;
        }
        .file-actions .download-btn {
            background-color: #22c55e; /* Green */
        }
        .file-actions .download-btn:hover {
            background-color: #16a34a;
        }
        .file-actions .delete-btn {
            background-color: #ef4444; /* Red */
        }
        .file-actions .delete-btn:hover {
            background-color: #dc2626;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }
        .modal-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* Allow content to stack */
            justify-content: center;
            align-items: center;
            min-height: 100px; /* Ensure some height for content */
        }
        .modal-body img {
            max-width: 100%;
            max-height: 70vh; /* Limit image height within modal */
            object-fit: contain;
            border-radius: 8px;
        }
        .modal-body pre {
            white-space: pre-wrap; /* Wrap long lines */
            word-break: break-all; /* Break words if necessary */
            max-height: 70vh;
            overflow-y: auto;
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            width: 100%;
        }
        .pdf-viewer-container {
            width: 100%;
            max-height: 70vh;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }
        .pdf-viewer-container canvas {
            max-width: 100%;
            height: auto;
            display: block; /* Remove extra space below canvas */
        }
        .pdf-page-nav {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">AWS S3 Browser SDK Demo</h1>

        <div class="warning">
            <p class="font-bold">Security Warning:</p>
            <p class="text-sm">
                Entering AWS credentials directly into client-side code is highly insecure and NOT recommended for production applications. This demo is for educational purposes only.
                In a real application, use AWS Cognito, IAM roles, or a backend service to manage S3 access securely.
            </p>
        </div>

        <!-- AWS Configuration Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">AWS Configuration</h2>
            <div>
                <label for="accessKeyId" class="block text-sm font-medium text-gray-700 mb-1">Access Key ID:</label>
                <input type="text" id="accessKeyId" placeholder="Your AWS Access Key ID" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="secretAccessKey" class="block text-sm font-medium text-gray-700 mb-1">Secret Access Key:</label>
                <input type="text" id="secretAccessKey" placeholder="Your AWS Secret Access Key" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="region" class="block text-sm font-medium text-gray-700 mb-1">Region:</label>
                <input type="text" id="region" value="us-east-1" placeholder="e.g., us-east-1" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="bucketName" class="block text-sm font-medium text-gray-700 mb-1">Bucket Name:</label>
                <input type="text" id="bucketName" placeholder="Your S3 Bucket Name" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button id="configureAwsBtn" class="w-full">Configure AWS</button>
        </div>

        <!-- File Operations Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">File Operations</h2>

            <!-- Upload File -->
            <div>
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Upload File:</label>
                <input type="file" id="fileInput" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <button id="uploadBtn" class="mt-3 w-full">Upload File</button>
            </div>

            <!-- List Files -->
            <div>
                <button id="listBtn" class="w-full">List Files</button>
                <div id="fileList" class="mt-4 border border-gray-200 rounded-lg p-4 bg-gray-50 max-h-60 overflow-y-auto">
                    <p class="text-gray-500 text-center">No files listed yet. Click "List Files".</p>
                </div>
            </div>
        </div>

        <!-- Message Display Area -->
        <div id="messageBox" class="message-box hidden"></div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewFileName">File Preview</h3>
                <span class="close-button" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- AWS SDK for JavaScript v2 CDN -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1093.0.min.js"></script>
    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        // Set the workerSrc for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // Global AWS S3 instance
        let s3;
        let bucketName;

        // Get DOM elements
        const accessKeyIdInput = document.getElementById('accessKeyId');
        const secretAccessKeyInput = document.getElementById('secretAccessKey');
        const regionInput = document.getElementById('region');
        const bucketNameInput = document.getElementById('bucketName');
        const configureAwsBtn = document.getElementById('configureAwsBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const listBtn = document.getElementById('listBtn');
        const fileListDiv = document.getElementById('fileList');
        const messageBox = document.getElementById('messageBox');

        // Modal elements..
        const previewModal = document.getElementById('previewModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const previewFileName = document.getElementById('previewFileName');
        const previewContent = document.getElementById('previewContent');

        /**
         * Displays a message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.classList.remove('hidden');
            // Hide message after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Initializes the AWS S3 client.
         */
        configureAwsBtn.addEventListener('click', () => {
            const accessKeyId = accessKeyIdInput.value.trim();
            const secretAccessKey = secretAccessKeyInput.value.trim();
            const region = regionInput.value.trim();
            bucketName = bucketNameInput.value.trim(); // Assign to global bucketName

            if (!accessKeyId || !secretAccessKey || !region || !bucketName) {
                showMessage('Please fill in all AWS configuration fields.', 'error');
                return;
            }

            try {
                AWS.config.update({
                    accessKeyId: accessKeyId,
                    secretAccessKey: secretAccessKey,
                    region: region
                });
                s3 = new AWS.S3({ apiVersion: '2006-03-01' });
                showMessage('AWS S3 configured successfully!', 'success');
                // Enable file operation buttons
                uploadBtn.disabled = false;
                listBtn.disabled = false;
            } catch (error) {
                showMessage(`Error configuring AWS: ${error.message}`, 'error');
                console.error('AWS Configuration Error:', error);
            }
        });

        /**
         * Uploads a selected file to S3.
         */
        uploadBtn.addEventListener('click', async () => {
            if (!s3 || !bucketName) {
                showMessage('Please configure AWS first.', 'error');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                showMessage('Please select a file to upload.', 'error');
                return;
            }

            const params = {
                Bucket: bucketName,
                Key: file.name, // Use the file name as the S3 object key
                Body: file,
                ContentType: file.type // Set content type for proper handling
            };

            try {
                await s3.putObject(params).promise();
                showMessage(`File "${file.name}" uploaded successfully!`, 'success');
                fileInput.value = ''; // Clear the file input
                listFiles(); // Refresh the file list
            } catch (error) {
                showMessage(`Error uploading file: ${error.message}`, 'error');
                console.error('Upload Error:', error);
            }
        });

        /**
         * Lists files in the S3 bucket.
         */
        async function listFiles() {
            if (!s3 || !bucketName) {
                fileListDiv.innerHTML = '<p class="text-gray-500 text-center">Please configure AWS first.</p>';
                return;
            }

            const params = {
                Bucket: bucketName
            };

            try {
                const data = await s3.listObjectsV2(params).promise();
                fileListDiv.innerHTML = ''; // Clear previous list

                if (data.Contents.length === 0) {
                    fileListDiv.innerHTML = '<p class="text-gray-500 text-center">No files found in the bucket.</p>';
                    return;
                }

                data.Contents.forEach(object => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span class="text-gray-700 font-medium">${object.Key}</span>
                        <div class="file-actions">
                            <button class="preview-btn" data-key="${object.Key}">Preview</button>
                            <button class="download-btn" data-key="${object.Key}">Download</button>
                            <button class="delete-btn" data-key="${object.Key}">Delete</button>
                        </div>
                    `;
                    fileListDiv.appendChild(fileItem);
                });

                // Add event listeners for preview, download and delete buttons
                fileListDiv.querySelectorAll('.preview-btn').forEach(button => {
                    button.addEventListener('click', (event) => previewFile(event.target.dataset.key));
                });
                fileListDiv.querySelectorAll('.download-btn').forEach(button => {
                    button.addEventListener('click', (event) => downloadFile(event.target.dataset.key));
                });
                fileListDiv.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => deleteFile(event.target.dataset.key));
                });

                showMessage(`Listed ${data.Contents.length} files.`, 'success');
            } catch (error) {
                showMessage(`Error listing files: ${error.message}`, 'error');
                console.error('List Files Error:', error);
            }
        }

        listBtn.addEventListener('click', listFiles);

        /**
         * Renders a PDF page onto a canvas.
         * @param {object} pdfDoc - The PDF document object.
         * @param {number} pageNum - The page number to render.
         * @param {HTMLCanvasElement} canvas - The canvas element to render on.
         * @param {number} scale - The scale factor for rendering.
         */
        async function renderPdfPage(pdfDoc, pageNum, canvas, scale) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;
        }

        /**
         * Previews a file from S3.
         * @param {string} key - The key (name) of the file to preview.
         */
        async function previewFile(key) {
            if (!s3 || !bucketName) {
                showMessage('Please configure AWS first.', 'error');
                return;
            }

            const params = {
                Bucket: bucketName,
                Key: key
            };

            previewFileName.textContent = `Preview: ${key}`;
            previewContent.innerHTML = '<p class="text-gray-500">Loading preview...</p>'; // Loading indicator
            previewModal.classList.remove('hidden');

            try {
                const data = await s3.getObject(params).promise();
                const contentType = data.ContentType;
                const fileBody = data.Body;

                previewContent.innerHTML = ''; // Clear loading message

                if (contentType.startsWith('image/')) {
                    const blob = new Blob([fileBody], { type: contentType });
                    const url = URL.createObjectURL(blob);
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Preview of ${key}`;
                    previewContent.appendChild(img);
                    // Revoke URL when modal is closed
                    closeModalBtn.onclick = () => {
                        previewModal.classList.add('hidden');
                        URL.revokeObjectURL(url);
                    };
                } else if (contentType.startsWith('text/')) {
                    const textDecoder = new TextDecoder('utf-8');
                    const textContent = textDecoder.decode(fileBody);
                    const pre = document.createElement('pre');
                    pre.textContent = textContent;
                    previewContent.appendChild(pre);
                } else if (contentType === 'application/pdf') {
                    // PDF.js integration
                    const pdfData = new Uint8Array(fileBody);
                    const loadingTask = pdfjsLib.getDocument({ data: pdfData });
                    const pdfDoc = await loadingTask.promise;

                    const pdfContainer = document.createElement('div');
                    pdfContainer.className = 'pdf-viewer-container';
                    previewContent.appendChild(pdfContainer);

                    // Render all pages for simplicity, or just the first page with navigation
                    for (let i = 1; i <= pdfDoc.numPages; i++) {
                        const canvas = document.createElement('canvas');
                        canvas.id = `pdf-canvas-${i}`;
                        pdfContainer.appendChild(canvas);
                        await renderPdfPage(pdfDoc, i, canvas, 1.5); // Render with a scale
                    }

                    // Optional: Add page navigation for very large PDFs
                    // If you only want to show one page at a time and add navigation:
                    /*
                    let currentPageNum = 1;
                    const canvas = document.createElement('canvas');
                    pdfContainer.appendChild(canvas);
                    const pageNav = document.createElement('div');
                    pageNav.className = 'pdf-page-nav';
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'Previous';
                    prevBtn.onclick = async () => {
                        if (currentPageNum > 1) {
                            currentPageNum--;
                            await renderPdfPage(pdfDoc, currentPageNum, canvas, 1.5);
                        }
                    };
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Next';
                    nextBtn.onclick = async () => {
                        if (currentPageNum < pdfDoc.numPages) {
                            currentPageNum++;
                            await renderPdfPage(pdfDoc, currentPageNum, canvas, 1.5);
                        }
                    };
                    pageNav.appendChild(prevBtn);
                    pageNav.appendChild(nextBtn);
                    pdfContainer.appendChild(pageNav);
                    await renderPdfPage(pdfDoc, currentPageNum, canvas, 1.5);
                    */

                } else {
                    // For other complex document types
                    previewContent.innerHTML = `
                        <p class="text-gray-700 text-center text-lg font-semibold">
                            Preview Not Available for This File Type
                        </p>
                        <p class="text-gray-600 text-center mt-2">
                            The file type <span class="font-bold">${contentType}</span> is a complex document format
                            (e.g., Word, Excel). Direct in-browser preview requires specialized
                            libraries or server-side processing which are not included in this demo.
                        </p>
                        <p class="text-gray-600 text-center mt-3">
                            Please use the "Download" button to view this file with appropriate software.
                        </p>
                    `;
                }

                showMessage(`Previewing "${key}".`, 'success');
            } catch (error) {
                previewContent.innerHTML = `<p class="text-red-500">Error loading preview: ${error.message}</p>`;
                showMessage(`Error previewing file "${key}": ${error.message}`, 'error');
                console.error('Preview Error:', error);
            }
        }

        /**
         * Downloads a file from S3.
         * @param {string} key - The key (name) of the file to download.
         */
        async function downloadFile(key) {
            if (!s3 || !bucketName) {
                showMessage('Please configure AWS first.', 'error');
                return;
            }

            const params = {
                Bucket: bucketName,
                Key: key
            };

            try {
                // Get the object content
                const data = await s3.getObject(params).promise();

                // Create a Blob from the file content
                const blob = new Blob([data.Body], { type: data.ContentType });

                // Create a temporary URL for the blob
                const url = URL.createObjectURL(blob);

                // Create a temporary anchor element to trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = key; // Set the download file name
                document.body.appendChild(a);
                a.click(); // Programmatically click the link to trigger download
                document.body.removeChild(a); // Clean up
                URL.revokeObjectURL(url); // Release the object URL

                showMessage(`File "${key}" downloaded successfully!`, 'success');
            } catch (error) {
                showMessage(`Error downloading file "${key}": ${error.message}`, 'error');
                console.error('Download Error:', error);
            }
        }

        /**
         * Deletes a file from S3.
         * @param {string} key - The key (name) of the file to delete.
         */
        async function deleteFile(key) {
            if (!s3 || !bucketName) {
                showMessage('Please configure AWS first.', 'error');
                return;
            }

            // In a real app, you'd add a confirmation dialog here.
            // For this demo, we'll proceed directly.

            const params = {
                Bucket: bucketName,
                Key: key
            };

            try {
                await s3.deleteObject(params).promise();
                showMessage(`File "${key}" deleted successfully!`, 'success');
                listFiles(); // Refresh the file list
            } catch (error) {
                showMessage(`Error deleting file: ${error.message}`, 'error');
                console.error('Delete Error:', error);
            }
        }

        // Initial state: Disable buttons until AWS is configured
        uploadBtn.disabled = true;
        listBtn.disabled = true;

        // Modal close functionality
        closeModalBtn.addEventListener('click', () => {
            previewModal.classList.add('hidden');
            previewContent.innerHTML = ''; // Clear content when closing
        });

        // Close modal if user clicks outside of it
        window.addEventListener('click', (event) => {
            if (event.target === previewModal) {
                previewModal.classList.add('hidden');
                previewContent.innerHTML = ''; // Clear content when closing
            }
        });

        // Optional: Load saved credentials from localStorage (for convenience in demo)
        window.onload = () => {
            accessKeyIdInput.value = localStorage.getItem('awsAccessKeyId') || '';
            secretAccessKeyInput.value = localStorage.getItem('awsSecretAccessKey') || '';
            regionInput.value = localStorage.getItem('awsRegion') || 'us-east-1';
            bucketNameInput.value = localStorage.getItem('awsBucketName') || '';

            // Auto-configure if credentials are found on load
            if (accessKeyIdInput.value && secretAccessKeyInput.value && regionInput.value && bucketNameInput.value) {
                configureAwsBtn.click();
            }
        };

        // Optional: Save credentials to localStorage when configured (for convenience in demo)
        configureAwsBtn.addEventListener('click', () => {
            localStorage.setItem('awsAccessKeyId', accessKeyIdInput.value);
            localStorage.setItem('awsSecretAccessKey', secretAccessKeyInput.value);
            localStorage.setItem('awsRegion', regionInput.value);
            localStorage.setItem('awsBucketName', bucketNameInput.value);
        });

    </script>
</body>
</html>
